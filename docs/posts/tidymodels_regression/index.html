<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Masumbuko Semba">
<meta name="dcterms.date" content="2023-04-11">

<title>ng’ara - Machine learning with tidymodels: Linear and Bayesian Regression Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../ngara.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-XCGZZVKFDT"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-XCGZZVKFDT', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../../styles.css">
<meta name="twitter:title" content="ng’ara - Machine learning with tidymodels: Linear and Bayesian Regression Models">
<meta name="twitter:description" content="Coding for all for better today and tommorow">
<meta name="twitter:image" content="https://lugoga.github.io/semba-quarto/posts/tidymodels_regression/regression.jpg">
<meta name="twitter:creator" content="@semba753">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">ng’ara</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/lugoga"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/semba2020"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.youtube.com/channel/UC9uZ1KPyo7zIzI4BnUtHPfA"> <i class="bi bi-youtube" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../blog.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-apps--links" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Apps &amp; Links</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-apps--links">    
        <li>
    <a class="dropdown-item" href="https://semba.netlify.app/">
 <span class="dropdown-text">Semba-blog Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://semba-blog.netlify.app/">
 <span class="dropdown-text">Semba Data Analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://semba.shinyapps.io/kwala/">
 <span class="dropdown-text">Kwala commercial CIty</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://semba.shinyapps.io/coastal_dashboard/">
 <span class="dropdown-text">Marine Hub</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://nemp.shinyapps.io/nemp/">
 <span class="dropdown-text">Environmental Master Plan</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://semba.shinyapps.io/OceanWebApp/">
 <span class="dropdown-text">Hydrographic Data Hub</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://semba.shinyapps.io/marineTz/">
 <span class="dropdown-text">Potential Fishing Zones</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://semba.shinyapps.io/vizingaApp/">
 <span class="dropdown-text">TAFIRI Apps</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://rweekly.org/">
 <span class="dropdown-text">R Weekly</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://www.r-bloggers.com/">
 <span class="dropdown-text">R Bloggers</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://www.tmbish.me/lab/highcharter-cookbook/">
 <span class="dropdown-text">Highcharter</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../archive.html"> 
<span class="menu-text">Archive</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#the-dataset" id="toc-the-dataset" class="nav-link" data-scroll-target="#the-dataset">The dataset</a></li>
  <li><a href="#resample" id="toc-resample" class="nav-link" data-scroll-target="#resample">Resample</a></li>
  <li><a href="#recipe" id="toc-recipe" class="nav-link" data-scroll-target="#recipe">recipe</a></li>
  <li><a href="#build-models" id="toc-build-models" class="nav-link" data-scroll-target="#build-models">Build Models</a>
  <ul class="collapse">
  <li><a href="#random-forest" id="toc-random-forest" class="nav-link" data-scroll-target="#random-forest">Random Forest</a>
  <ul class="collapse">
  <li><a href="#make-random-forest-model" id="toc-make-random-forest-model" class="nav-link" data-scroll-target="#make-random-forest-model">Make random forest model</a></li>
  <li><a href="#train-random-forest-model" id="toc-train-random-forest-model" class="nav-link" data-scroll-target="#train-random-forest-model">Train random forest model</a></li>
  <li><a href="#predict-with-random-forest" id="toc-predict-with-random-forest" class="nav-link" data-scroll-target="#predict-with-random-forest">predict with random forest</a></li>
  <li><a href="#evaluate-the-rf-model" id="toc-evaluate-the-rf-model" class="nav-link" data-scroll-target="#evaluate-the-rf-model">Evaluate the rf model</a></li>
  </ul></li>
  <li><a href="#linear-regression-approach" id="toc-linear-regression-approach" class="nav-link" data-scroll-target="#linear-regression-approach">Linear regression approach</a>
  <ul class="collapse">
  <li><a href="#make-linear-model" id="toc-make-linear-model" class="nav-link" data-scroll-target="#make-linear-model">Make linear model</a></li>
  <li><a href="#train-linear-model" id="toc-train-linear-model" class="nav-link" data-scroll-target="#train-linear-model">Train Linear model</a></li>
  <li><a href="#predict-with-linear-model" id="toc-predict-with-linear-model" class="nav-link" data-scroll-target="#predict-with-linear-model">Predict with linear model</a></li>
  <li><a href="#evaluate-linear-model" id="toc-evaluate-linear-model" class="nav-link" data-scroll-target="#evaluate-linear-model">Evaluate linear model</a></li>
  <li><a href="#estimate-stats" id="toc-estimate-stats" class="nav-link" data-scroll-target="#estimate-stats">Estimate stats</a></li>
  </ul></li>
  <li><a href="#bayesian-approach" id="toc-bayesian-approach" class="nav-link" data-scroll-target="#bayesian-approach">Bayesian approach</a>
  <ul class="collapse">
  <li><a href="#make-bayes-model" id="toc-make-bayes-model" class="nav-link" data-scroll-target="#make-bayes-model">Make Bayes Model</a></li>
  <li><a href="#train-bayes-model" id="toc-train-bayes-model" class="nav-link" data-scroll-target="#train-bayes-model">Train Bayes model</a></li>
  <li><a href="#predict-bayes-fit" id="toc-predict-bayes-fit" class="nav-link" data-scroll-target="#predict-bayes-fit">Predict Bayes fit</a></li>
  <li><a href="#evaluate-bayes-model" id="toc-evaluate-bayes-model" class="nav-link" data-scroll-target="#evaluate-bayes-model">Evaluate Bayes model</a></li>
  <li><a href="#bayes.fit.stats" id="toc-bayes.fit.stats" class="nav-link" data-scroll-target="#bayes.fit.stats">Bayes.fit.stats</a></li>
  </ul></li>
  <li><a href="#links" id="toc-links" class="nav-link" data-scroll-target="#links">Links</a></li>
  <li><a href="#cited-materials" id="toc-cited-materials" class="nav-link" data-scroll-target="#cited-materials">Cited Materials</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Machine learning with tidymodels: Linear and Bayesian Regression Models</h1>
  <div class="quarto-categories">
    <div class="quarto-category">Manipulation</div>
    <div class="quarto-category">Visualization</div>
    <div class="quarto-category">R</div>
    <div class="quarto-category">Modelling</div>
  </div>
  </div>


<div class="quarto-title-meta-author">
  <div class="quarto-title-meta-heading">Author</div>
  <div class="quarto-title-meta-heading">Affiliation</div>
  
    <div class="quarto-title-meta-contents">
    <p class="author"><a href="https://semba.netlify.app">Masumbuko Semba</a> <a href="https://orcid.org/0000-0002-5002-9747" class="quarto-title-author-orcid"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg=="></a></p>
  </div>
  <div class="quarto-title-meta-contents">
        <p class="affiliation">
            <a href="https://semba.netlify.app/">
            Nelson Mandela African Institution of Science and Technology
            </a>
          </p>
      </div>
  </div>

<div class="quarto-title-meta">

      
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">April 11, 2023</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>We live in age of increasing data and as a data scientist, our role primarily involves exploring and analyzing data. However, with the amount of data data exploration and analysis become a thing for automation and use of intelligent tools to help us glean key information from data. The results of an analysis might form the basis of a report or a machine learning model, but it all begins with data. The two popular tools commonly used are R and Python. R is one of the most popular programming languages for data scientists. R is an elegant environment that’s designed to support data science, and you can use it for many purposes.</p>
<p>After decades of open-source development, R provides extensive functionality that’s backed by a massive set of powerful statistical modeling, machine learning, visualization and data wrangling packages. Some of these package that has revolutionized R are <strong>tidyverse</strong> and <strong>tidymodel</strong> package. <strong>tidyverse</strong> is a collection of R packages that make data science faster, easier, and more fun and <strong>tidymodels</strong> is a collection of R packages for modeling and statistical analysis.</p>
<p>As a data scientist, you need to distinguish between <em>regression predictive models</em> and <em>classification predictive models</em>. Clear understanding of these models helps to choose the best one for a specific use case. In a nutshell, <em>regression predictive models</em>and <em>classification predictive models</em> fall under supervised machine learning. The main difference between these two models is the output: while in regression produce an output as numerical (or continuous), the output of classification is categorical (or discrete).</p>
<p>A big part of machine learning is <em>classification</em> — we want to know what class or group an observation belongs to. Therefore, the ability to precisely classify observations to their groups is valuable for various business applications like predicting the future based on historical data. For example, when provided with a dataset about environmental variables, and you are asked to predict productivity, that is a regression task because productivity measured in term of chlorophyll concentration will be a continuous output.</p>
<p>In this post we will focus on regression. We will learn the steps of modelling using <strong>tidymodels</strong> <span class="citation" data-cites="tidymodels">(<a href="#ref-tidymodels" role="doc-biblioref">Kuhn and Wickham, 2020a</a>)</span>. We first explore the data and check if it fit for modelling, we then split the dataset into a training and testing sets. Next, we will create a recipe object and define our model. Lastly, we will train a specified model and evaluate its performance. I will use the same dataset for three different model’s algorithms. Example of the common regression algorithms include <code>random forest</code>, <code>linear regression</code>, <code>support vector regression (SVR)</code> and <code>bayes</code>. Some algorithms, such as <code>logistic regression</code>, have the name <code>regression</code> in their functions but they are not regression algorithms.</p>
<p>To follow use code in this article, you will need <strong>tidymodels</strong> <span class="citation" data-cites="tidymodels">(<a href="#ref-tidymodels" role="doc-biblioref">Kuhn and Wickham, 2020a</a>)</span> and <strong>tidyverse</strong> packages <span class="citation" data-cites="tidyverse">(<a href="#ref-tidyverse" role="doc-biblioref">Wickham and Wickham, 2017</a>)</span> installed in your machine. You can install them from CRAN. The chunk below highlight lines of code to install the packages if they are yet in your PC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a>model.packages <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"tidymodels"</span>, <span class="st">"tidyverse"</span>)</span>
<span id="cb1-2"><a href="#cb1-2"></a></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">install.packages</span>(model.packages)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>similar to the <strong>tidyverse</strong>, <strong>tidymodels</strong> consists of several linked packages that use a similar philosophy and syntax. Here is a brief explanation of the component packages.</p>
<ol type="1">
<li><strong>parsnips</strong>: used to define models using a common syntax; makes it easier to experiment with different algorithms</li>
<li><strong>workflows</strong>: provides tools to create workflows, or the desired machine learning pipeline, including pre-processing, training, and post-processing</li>
<li><strong>yardstick</strong>: a one-stop-shop to implement a variety of assessment metrics for regression and classification problems</li>
<li><strong>tune</strong>: for hyperparameter tuning</li>
<li><strong>dials</strong>: for managing parameters and tuning grids</li>
<li><strong>rsample</strong>: tools for data splitting, partitioning, and resampling</li>
<li><strong>recipes</strong>: tools for pre-processing and data engineering</li>
</ol>
<p>Once installed, you can load the packages in your session. I begin by reading in the required packages. Here, tidymodels is used to load the component packages discussed above along with some other packages (e.g., ggplot2, purr, and dplyr).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">require</span>(tidymodels)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-dataset" class="level1">
<h1>The dataset</h1>
<p>We use the data collected with the Institute of Marine Sciences of the University of Dar es Salaam to illustrate the concept. The data was collected through the Coral Reef Targeted Research and Capacity Building for Management (CRTR) project between 2008 and 2009. The dataset contains;</p>
<ul>
<li>Chemical variables —nitrate, phosphate, salinity, pH, dissolved oxygen and ammonia</li>
<li>Physical variables — temperature</li>
<li>Biological variables— chlorophyll-<em>a</em></li>
</ul>
<p>Because the variables are organized in sheets of Excel spreadsheet, i used a <code>read_excel</code> function from <strong>readxl</strong> package <span class="citation" data-cites="readxl">(<a href="#ref-readxl" role="doc-biblioref">Wickham and Bryan, 2018</a>)</span> to read the file from the sheet. And because there are several sheet, the processed was iterated with a <code>for</code> loop. Data from each sheet was allocated in the list file. The chunk below highlight the code used to read files in sheets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>variables <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"salinity"</span>, <span class="st">"temperature"</span>, <span class="st">"do"</span>, <span class="st">"ph"</span>, <span class="st">"chl"</span>, <span class="st">"ammonia"</span>, <span class="st">"phosphate"</span>, <span class="st">"nitrate"</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a></span>
<span id="cb3-3"><a href="#cb3-3"></a>crtr.list <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(variables)){</span>
<span id="cb3-6"><a href="#cb3-6"></a>  </span>
<span id="cb3-7"><a href="#cb3-7"></a>  crtr.list[[i]] <span class="ot">=</span> readxl<span class="sc">::</span><span class="fu">read_excel</span>(<span class="st">"../data/crtr.xlsx"</span>, <span class="at">sheet =</span> i) <span class="sc">%&gt;%</span> </span>
<span id="cb3-8"><a href="#cb3-8"></a>    <span class="fu">mutate</span>(<span class="at">variable =</span> variables[i]) </span>
<span id="cb3-9"><a href="#cb3-9"></a></span>
<span id="cb3-10"><a href="#cb3-10"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data was untidy and unsuitable for visualization and modelling in R. Therefore, the first thing I had to deal with the data was to tidy the variables in the dataset to a right format that <strong>tidymodels</strong> and <strong>tidyverse</strong> recognizes. First the dataset was unlisted with <code>bind_rows</code> function and the data was pivoted to long format and then back to wide format with only the variable of interested selected.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="do">## organize in long form</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>crtr.long <span class="ot">=</span> crtr.list <span class="sc">%&gt;%</span> </span>
<span id="cb4-3"><a href="#cb4-3"></a>  <span class="fu">bind_rows</span>() <span class="sc">%&gt;%</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span><span class="dv">2</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">names_to =</span> <span class="st">"sites"</span>, <span class="at">values_to =</span> <span class="st">"data"</span> ) </span>
<span id="cb4-5"><a href="#cb4-5"></a></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="do">## organize in the wide form</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>crtr.wide <span class="ot">=</span> crtr.long <span class="sc">%&gt;%</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> variable, <span class="at">values_from =</span> data) <span class="sc">%&gt;%</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>  <span class="fu">mutate</span>(<span class="at">month =</span> lubridate<span class="sc">::</span><span class="fu">month</span>(Date, <span class="at">label =</span> <span class="cn">TRUE</span>, </span>
<span id="cb4-10"><a href="#cb4-10"></a>                                  <span class="at">abb =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span> <span class="fu">as.character</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>  <span class="fu">mutate_if</span>(is.character, as.factor) <span class="sc">%&gt;%</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>  <span class="fu">mutate_if</span>(is.numeric, round, <span class="at">digits =</span> <span class="dv">2</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>  <span class="fu">select</span>(<span class="at">date =</span> Date, month,sites, chl, <span class="fu">everything</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s us glimpse the dataset</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>crtr.wide <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 52
Columns: 11
$ date        &lt;dttm&gt; 2008-03-01, 2008-03-01, 2008-03-01, 2008-03-01, 2008-04-0~
$ month       &lt;fct&gt; Mar, Mar, Mar, Mar, Apr, Apr, Apr, Apr, May, May, May, May~
$ sites       &lt;fct&gt; Pongwe, Mnemba, Chumbe, Bawe, Pongwe, Mnemba, Chumbe, Bawe~
$ chl         &lt;dbl&gt; 0.09, 0.26, 0.56, 0.43, 0.47, 1.01, 0.63, 1.39, 0.37, 0.33~
$ salinity    &lt;dbl&gt; 35.0, 34.0, 32.0, 32.0, 35.0, 35.0, 34.0, 34.0, 36.0, 36.0~
$ temperature &lt;dbl&gt; 28.8, 28.4, 28.0, 28.0, 28.2, 27.7, 28.1, 26.7, 27.0, 27.2~
$ do          &lt;dbl&gt; 6.11, 5.95, 6.16, NA, 6.35, 6.14, 7.01, 6.31, 6.15, 6.10, ~
$ ph          &lt;dbl&gt; 7.86, 7.88, 7.73, NA, 7.87, 7.88, 7.86, 7.91, 7.68, 7.80, ~
$ ammonia     &lt;dbl&gt; 0.55, 0.80, 0.74, 0.94, 0.56, 0.72, 0.53, 0.97, 0.56, 0.65~
$ phosphate   &lt;dbl&gt; 0.28, 0.28, 1.31, 1.91, 0.28, 0.32, 1.16, 0.84, 0.28, 0.43~
$ nitrate     &lt;dbl&gt; 0.04, 0.07, 3.26, 3.34, 0.03, 0.47, 1.45, 0.84, 0.06, 0.48~</code></pre>
</div>
</div>
<p>As a first step in modeling, it’s always a good idea to explore the variables in the dataset. <a href="#fig-fig0" class="quarto-xref">Figure&nbsp;1</a> is a pairplot that compare each pair of variables as scatterplots in the lower diagonal, densities on the diagonal and correlations written in the upper diagonal <span class="citation" data-cites="ggally">(<a href="#ref-ggally" role="doc-biblioref">Schloerke et al., 2020</a>)</span>. <a href="#fig-fig1" class="quarto-xref">Figure&nbsp;2</a> show the correlation between chlorophyll-<em>a</em> (outcome) with other six predictor variables using a linear and quadratic equations is unfit for these dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>crtr.wide <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="fu">select</span>(<span class="sc">-</span>salinity)<span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>  <span class="fu">mutate</span>(<span class="at">season =</span> lubridate<span class="sc">::</span><span class="fu">month</span>(date) <span class="sc">%&gt;%</span> <span class="fu">as.integer</span>(),</span>
<span id="cb7-4"><a href="#cb7-4"></a>         <span class="at">season =</span> <span class="fu">replace</span>(season,season <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>,<span class="dv">11</span><span class="sc">:</span><span class="dv">12</span>), <span class="st">"NE"</span>),</span>
<span id="cb7-5"><a href="#cb7-5"></a>         <span class="at">season =</span> <span class="fu">replace</span>(season,season <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">10</span>), <span class="st">"SE"</span>))<span class="sc">%&gt;%</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>  GGally<span class="sc">::</span><span class="fu">ggscatmat</span>(<span class="at">columns =</span> <span class="dv">4</span><span class="sc">:</span><span class="dv">10</span>,<span class="at">color=</span><span class="st">"season"</span>, <span class="at">alpha=</span><span class="dv">1</span>, <span class="at">corMethod =</span> <span class="st">"spearman"</span>)<span class="sc">+</span></span>
<span id="cb7-7"><a href="#cb7-7"></a>  ggsci<span class="sc">::</span><span class="fu">scale_color_jco</span>()<span class="sc">+</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>  ggpubr<span class="sc">::</span><span class="fu">theme_pubclean</span>()<span class="sc">+</span></span>
<span id="cb7-9"><a href="#cb7-9"></a>  <span class="fu">theme</span>(<span class="at">strip.background =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb7-10"><a href="#cb7-10"></a>        <span class="at">legend.position =</span> <span class="st">"right"</span>,</span>
<span id="cb7-11"><a href="#cb7-11"></a>        <span class="at">legend.key =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-fig0" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-fig0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-fig0-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fig0-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Pair plot of numerical variables
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>wesa <span class="ot">=</span> wesanderson<span class="sc">::</span>wes_palettes <span class="sc">%&gt;%</span> <span class="fu">names</span>()</span>
<span id="cb8-2"><a href="#cb8-2"></a></span>
<span id="cb8-3"><a href="#cb8-3"></a>crtr.wide <span class="sc">%&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>  <span class="fu">select</span>(<span class="sc">-</span>salinity)<span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>  <span class="fu">filter</span>(nitrate <span class="sc">&lt;</span> <span class="dv">1</span> <span class="sc">&amp;</span> phosphate <span class="sc">&lt;</span> <span class="fl">1.2</span> <span class="sc">&amp;</span> chl <span class="sc">&lt;</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb8-6"><a href="#cb8-6"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="dv">5</span><span class="sc">:</span><span class="dv">10</span>, <span class="at">names_to =</span> <span class="st">"predictor"</span>, <span class="at">values_to =</span> <span class="st">"data"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>  <span class="co"># filter(sites == "Bawe")%&gt;%</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> data, <span class="at">y =</span> chl))<span class="sc">+</span></span>
<span id="cb8-9"><a href="#cb8-9"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">trans =</span> scales<span class="sc">::</span><span class="fu">sqrt_trans</span>(), <span class="at">labels =</span> <span class="cf">function</span>(x) <span class="fu">round</span>(x,<span class="dv">2</span>))<span class="sc">+</span></span>
<span id="cb8-10"><a href="#cb8-10"></a>  <span class="co"># scale_x_continuous(trans = scales::sqrt_trans(), labels = function(x) round(x,2))+</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>  <span class="fu">geom_jitter</span>()<span class="sc">+</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">formula =</span> <span class="st">"y ~ poly(x,2)"</span>, <span class="fu">aes</span>(<span class="at">color =</span> <span class="st">"Quadratic"</span>))<span class="sc">+</span></span>
<span id="cb8-13"><a href="#cb8-13"></a>  <span class="fu">geom_smooth</span>(<span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">formula =</span> <span class="st">"y ~ x"</span>, <span class="fu">aes</span>(<span class="at">color =</span> <span class="st">"Linear"</span>))<span class="sc">+</span></span>
<span id="cb8-14"><a href="#cb8-14"></a>   ggsci<span class="sc">::</span><span class="fu">scale_color_jco</span>()<span class="sc">+</span></span>
<span id="cb8-15"><a href="#cb8-15"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>predictor, <span class="at">scales =</span> <span class="st">"free_x"</span>)<span class="sc">+</span></span>
<span id="cb8-16"><a href="#cb8-16"></a>  ggpubr<span class="sc">::</span><span class="fu">theme_pubclean</span>()<span class="sc">+</span></span>
<span id="cb8-17"><a href="#cb8-17"></a>  <span class="fu">theme</span>(<span class="at">strip.background.x =</span> <span class="fu">element_blank</span>(), <span class="at">legend.key =</span> <span class="fu">element_blank</span>(), </span>
<span id="cb8-18"><a href="#cb8-18"></a>        <span class="at">legend.position =</span> <span class="st">"right"</span>, <span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">colour =</span> <span class="st">"black"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-fig1" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-fig1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-fig1-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fig1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: Linear and quadratic correlation of environmental variables and chlorophyll-a
</figcaption>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>crtr.clean <span class="ot">=</span> crtr.wide <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="fu">select</span>(<span class="sc">-</span>salinity)<span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>  <span class="fu">filter</span>(nitrate <span class="sc">&lt;</span> <span class="dv">1</span> <span class="sc">&amp;</span> phosphate <span class="sc">&lt;</span> <span class="fl">1.2</span> <span class="sc">&amp;</span> chl <span class="sc">&lt;</span> <span class="dv">1</span>)  <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(date<span class="sc">:</span>sites))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="resample" class="level1">
<h1>Resample</h1>
<p>In machine learning, one risk is the machine learns too well our sample data and is then less accurate during a real-world testing. This phenomenon is called <em>overtraining</em> or <em>overfitting</em>. We overcome this problem by splitting the dataset into a training and testing sets. The training set is used to train the model while the test set is reserved to later estimate how well the model might work on new or wild data. The splitting is based on ratios and the widely used ratios include 80/20, 75/25, or 7/30, with the training data receiving a bigger proportion of the dataset and the test set get the remaining small portion.</p>
<p>For our sample that has only 52 observations, it make sense to use 70/30 split ratio. we use the fraction <code>set.seed(4595)</code> from base R to fix the random number generator from <strong>rsample</strong> package <span class="citation" data-cites="rsample">(<a href="#ref-rsample" role="doc-biblioref">Kuhn et al., 2020</a>)</span>. This prevent generating new data in each execution. the function <code>initial_split</code> from the <strong>rsample</strong> package is designed to split the dataset into a training and testing sets. We purse the data to be split and the proportion that serve as a cutpoint of the two sets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="fu">set.seed</span>(<span class="dv">4595</span>)</span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a>crtr.split <span class="ot">=</span> crtr.clean <span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>  rsample<span class="sc">::</span><span class="fu">initial_split</span>(<span class="at">prop =</span> <span class="fl">0.7</span>)</span>
<span id="cb10-5"><a href="#cb10-5"></a></span>
<span id="cb10-6"><a href="#cb10-6"></a>crtr.split</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;Analysis/Assess/Total&gt;
&lt;28/13/41&gt;</code></pre>
</div>
</div>
<p>Given the 41 total observations, we reserve 12 observations as a test set and kept 70% of the dataset (29 observation) as train set. From the <code>crtr.split</code> object, we pull both the train set with the <code>training</code> function and the test set with a <code>testing</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a><span class="do">## pull train set</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>crtr.train <span class="ot">=</span> crtr.split <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="fu">training</span>()</span>
<span id="cb12-4"><a href="#cb12-4"></a></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="do">## pull test set</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>crtr.test <span class="ot">=</span> crtr.split <span class="sc">%&gt;%</span> </span>
<span id="cb12-7"><a href="#cb12-7"></a>  <span class="fu">testing</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can have a glimpse of the train dataset using a <code>glimpse</code> function from <strong>dplyr</strong> package <span class="citation" data-cites="dplyr">(<a href="#ref-dplyr" role="doc-biblioref">Wickham et al., 2019</a>)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>crtr.train <span class="sc">%&gt;%</span> <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 28
Columns: 7
$ chl         &lt;dbl&gt; 0.44, 0.37, 0.25, 0.23, 0.47, 0.68, 0.45, 0.28, 0.33, 0.63~
$ temperature &lt;dbl&gt; 27.3, 27.0, 29.8, 28.9, 28.2, 28.2, 25.8, 27.2, 27.2, 29.2~
$ do          &lt;dbl&gt; 6.19, 6.15, 5.32, 5.56, 6.35, 5.36, 5.76, 5.46, 6.10, 5.12~
$ ph          &lt;dbl&gt; 7.85, 7.68, 8.30, 7.98, 7.87, 8.04, 8.02, 8.05, 7.80, 7.97~
$ ammonia     &lt;dbl&gt; 0.88, 0.56, 0.61, 1.32, 0.56, 0.14, 0.56, 0.52, 0.65, 0.66~
$ phosphate   &lt;dbl&gt; 0.92, 0.28, 0.51, 0.30, 0.28, 0.26, 0.17, 0.14, 0.43, 0.54~
$ nitrate     &lt;dbl&gt; 0.64, 0.06, 0.03, 0.04, 0.03, 0.05, 0.05, 0.04, 0.48, 0.20~</code></pre>
</div>
</div>
<p>The printed output shows that we have seven variables and all are numeric</p>
</section>
<section id="recipe" class="level1">
<h1>recipe</h1>
<p>The <strong>recipes</strong> package <span class="citation" data-cites="recipes">(<a href="#ref-recipes" role="doc-biblioref">Kuhn and Wickham, 2020b</a>)</span> define a recipe object that we will use for modeling and to conduct preprocessing of variables. The four main functions are <code>recipe()</code>, <code>prep()</code>, <code>juice()</code> and <code>bake()</code>. <code>recipe()</code> defines the operations on the data and the associated roles. Once the preprocessing steps are defined, any parameters are estimated using <code>prep()</code>.</p>
<p>Recipes can be created manually by sequentially adding roles to variables in a data set. First, we will create a recipe object from the train set data and then specify the processing steps and transform the data with <code>step_*</code>. once the recipe is ready we prep it. For example, to create a simple recipe containing only an outcome and predictors and have the predictors normalized and missing values in predictors imputed:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>crtr.recipe <span class="ot">=</span> crtr.train <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="fu">recipe</span>(chl <span class="sc">~</span> .) <span class="sc">%&gt;%</span></span>
<span id="cb15-3"><a href="#cb15-3"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>  <span class="fu">step_corr</span>(<span class="fu">all_numeric</span>())<span class="sc">%&gt;%</span></span>
<span id="cb15-5"><a href="#cb15-5"></a>  <span class="fu">step_impute_knn</span>(<span class="fu">all_numeric</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>  <span class="fu">prep</span>()</span>
<span id="cb15-7"><a href="#cb15-7"></a></span>
<span id="cb15-8"><a href="#cb15-8"></a>crtr.recipe</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Recipe

Inputs:

      role #variables
   outcome          1
 predictor          6

Training data contained 28 data points and no missing data.

Operations:

Centering and scaling for temperature, do, ph, ammonia, phosphate, nitrat... [trained]
Correlation filter on &lt;none&gt; [trained]
K-nearest neighbor imputation for temperature, do, ph, ammonia, phosphate, nitra... [trained]</code></pre>
</div>
</div>
<p>Once the data are ready for transformation, the <code>juices()</code> extract transformed training set while the <code>bake()</code> function create a new testing set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>crtr.training <span class="ot">=</span> crtr.recipe <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>  <span class="fu">juice</span>()</span>
<span id="cb17-3"><a href="#cb17-3"></a></span>
<span id="cb17-4"><a href="#cb17-4"></a>crtr.testing <span class="ot">=</span> crtr.recipe <span class="sc">%&gt;%</span></span>
<span id="cb17-5"><a href="#cb17-5"></a>  <span class="fu">bake</span>(crtr.test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="build-models" class="level1">
<h1>Build Models</h1>
<section id="random-forest" class="level2">
<h2 class="anchored" data-anchor-id="random-forest">Random Forest</h2>
<p>We begin by fitting a random forest model.</p>
<section id="make-random-forest-model" class="level3">
<h3 class="anchored" data-anchor-id="make-random-forest-model">Make random forest model</h3>
<p>We specify the model using the <strong>parsnip</strong> package <span class="citation" data-cites="parsnip">(<a href="#ref-parsnip" role="doc-biblioref">Kuhn and Vaughan, 2020a</a>)</span>. This package provides a tidy, unified interface to models for a range of models without getting bogged down in the syntactical minutiae of the underlying packages. The <strong>parsnip</strong> package help us to specify ;</p>
<ul>
<li>the <code>type</code> of model e.g <strong>random forest</strong>,</li>
<li>the <code>mode</code> of the model whether is <code>regression</code> or <code>classification</code></li>
<li>the computational <code>engine</code> is the name of the R package.</li>
</ul>
<p>Based on the information above, we can use <strong>parsnip</strong> package to build our model as;</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>rf.model <span class="ot">=</span> <span class="fu">rand_forest</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2"></a>  <span class="fu">set_engine</span>(<span class="at">engine =</span> <span class="st">"ranger"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3"></a>  <span class="fu">set_mode</span>(<span class="at">mode =</span> <span class="st">"regression"</span>)</span>
<span id="cb18-4"><a href="#cb18-4"></a></span>
<span id="cb18-5"><a href="#cb18-5"></a>rf.model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Random Forest Model Specification (regression)

Computational engine: ranger </code></pre>
</div>
</div>
</section>
<section id="train-random-forest-model" class="level3">
<h3 class="anchored" data-anchor-id="train-random-forest-model">Train random forest model</h3>
<p>Once we have specified the model type, engine and mode, the model can be trained with the <code>fit</code> function. We simply parse into the fit the specified model and the transformed training set extracted from the prepped recipe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>rf.fit <span class="ot">=</span> rf.model <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2"></a>  <span class="fu">fit</span>(chl <span class="sc">~</span> ., <span class="at">data =</span> crtr.training)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="predict-with-random-forest" class="level3">
<h3 class="anchored" data-anchor-id="predict-with-random-forest">predict with random forest</h3>
<p>To get our predicted results, we use the <code>predict()</code> function to find the estimated chlorophyll-<em>a</em>. First, let’s generate the estimated chlorophyll-<em>a</em> values by simply parse the random forest model <code>rf.model</code> we specified and the transformed testing set we created from a prepped recipe. We also stitch the predicted values to the transformed train set with <code>bind_cols</code> function;</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>rf.predict <span class="ot">=</span> rf.fit <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>  <span class="fu">predict</span>(crtr.testing) <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3"></a>  <span class="fu">bind_cols</span>(crtr.testing) </span>
<span id="cb21-4"><a href="#cb21-4"></a></span>
<span id="cb21-5"><a href="#cb21-5"></a>rf.predict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 x 8
     .pred temperature      do     ph ammonia phosphate nitrate     chl
     &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
 1 -0.143        0.407  0.624  -0.756  1.05     -0.485   -0.364 -0.685 
 2 -0.0964      -0.897  0.603  -1.56   0.401    -0.242   -0.419 -0.0561
 3 -0.0919      -0.897  0.516  -1.20   0.530     0.0808   1.32   0.206 
 4  0.366       -1.10   1.69   -1.64   0.562     1.86     3.49  -0.894 
 5 -0.0544      -0.966  1.30   -0.976 -0.0507   -0.565   -0.364 -0.161 
 6 -0.0748      -1.58  -0.0480 -1.12   0.498     0.0808   1.26  -1.31  
 7  0.0753      -1.58   1.17   -0.462  2.05     -0.525    0.721  0.573 
 8  0.160        0.887  0.538   0.493 -0.244     0.121   -0.473 -0.528 
 9  0.189        0.887  0.429   0.420 -0.890    -0.202    0.341 -0.528 
10 -0.0890       0.132 -0.850   0.567 -1.54     -0.767   -0.419 -0.632 
11 -0.386        0.613 -0.200   0.567  0.272    -0.767   -0.364 -0.423 
12 -0.0471       1.09  -0.503   0.714  1.66     -0.162   -0.419 -0.528 
13  0.800        1.16   0.386   1.67   0.0138    2.10    -0.419  2.09  </code></pre>
</div>
</div>
<p>When making predictions, the tidymodels convention is to always produce a tibble of results with standardized column names. This makes it easy to combine the original data and the predictions in a usable format:</p>
</section>
<section id="evaluate-the-rf-model" class="level3">
<h3 class="anchored" data-anchor-id="evaluate-the-rf-model">Evaluate the rf model</h3>
<p>So far, we have built a model and preprocessed data with a recipe. We predicted new data as a way to bundle a parsnip model and recipe together. The next step is to assess or evaluate the accuracy of the model. We use a <code>metrics</code> function from <strong>yardstick</strong> package <span class="citation" data-cites="yardstick">(<a href="#ref-yardstick" role="doc-biblioref">Kuhn and Vaughan, 2020b</a>)</span>to assess the accuracy of the model by comparing the predicted versus the original outcome variable. Note that we use the predicted dataset we just computed using <code>predict</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>rf.predict <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>  <span class="fu">metrics</span>(<span class="at">truth =</span> chl, <span class="at">estimate =</span> .pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 x 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rmse    standard       0.731
2 rsq     standard       0.363
3 mae     standard       0.595</code></pre>
</div>
</div>
</section>
</section>
<section id="linear-regression-approach" class="level2">
<h2 class="anchored" data-anchor-id="linear-regression-approach">Linear regression approach</h2>
<section id="make-linear-model" class="level3">
<h3 class="anchored" data-anchor-id="make-linear-model">Make linear model</h3>
<p>The good of <strong>tidymodels</strong> is that when we change the model, we do not need to start over again from the beginning but rather change the engine. For instance, we replace the <code>ranger</code> engine with <code>lm</code> to specify the linear model using the <strong>parsnip</strong> package <span class="citation" data-cites="parsnip">(<a href="#ref-parsnip" role="doc-biblioref">Kuhn and Vaughan, 2020a</a>)</span> .</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a>lm.model <span class="ot">=</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>  <span class="fu">set_engine</span>(<span class="at">engine =</span> <span class="st">"lm"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3"></a>  <span class="fu">set_mode</span>(<span class="at">mode =</span> <span class="st">"regression"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="train-linear-model" class="level3">
<h3 class="anchored" data-anchor-id="train-linear-model">Train Linear model</h3>
<p>Once we have specified the model type, engine and mode, the model can be trained with the <code>fit</code> function;</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>lm.fit <span class="ot">=</span> lm.model <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>  <span class="fu">fit</span>(chl <span class="sc">~</span> ., <span class="at">data =</span> crtr.training)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="predict-with-linear-model" class="level3">
<h3 class="anchored" data-anchor-id="predict-with-linear-model">Predict with linear model</h3>
<p>Once the model is fitted, This fitted object lm_fit has the lm model output built-in, which you can access with lm_fit$fit, but there are some benefits to using the fitted parsnip model object when it comes to predicting. To predict the values we use <code>predict</code> function and parse the model and standardized testing values we computed from the recipe <span class="citation" data-cites="r">(<a href="#ref-r" role="doc-biblioref">R Core Team, 2018</a>)</span>. Note that here we use the transformed test set and not the original from the split object. In this case we use the model to predict the value and stitch the testing values using the <code>bind_cols</code> function;</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>lm.predict <span class="ot">=</span> lm.fit <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>  <span class="fu">predict</span>(crtr.testing) <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3"></a>  <span class="fu">bind_cols</span>(crtr.testing) </span>
<span id="cb27-4"><a href="#cb27-4"></a></span>
<span id="cb27-5"><a href="#cb27-5"></a>lm.predict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 x 8
     .pred temperature      do     ph ammonia phosphate nitrate     chl
     &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
 1 -0.347        0.407  0.624  -0.756  1.05     -0.485   -0.364 -0.685 
 2 -0.239       -0.897  0.603  -1.56   0.401    -0.242   -0.419 -0.0561
 3 -0.260       -0.897  0.516  -1.20   0.530     0.0808   1.32   0.206 
 4  0.0430      -1.10   1.69   -1.64   0.562     1.86     3.49  -0.894 
 5 -0.238       -0.966  1.30   -0.976 -0.0507   -0.565   -0.364 -0.161 
 6 -0.243       -1.58  -0.0480 -1.12   0.498     0.0808   1.26  -1.31  
 7 -0.614       -1.58   1.17   -0.462  2.05     -0.525    0.721  0.573 
 8  0.142        0.887  0.538   0.493 -0.244     0.121   -0.473 -0.528 
 9  0.0942       0.887  0.429   0.420 -0.890    -0.202    0.341 -0.528 
10  0.115        0.132 -0.850   0.567 -1.54     -0.767   -0.419 -0.632 
11 -0.191        0.613 -0.200   0.567  0.272    -0.767   -0.364 -0.423 
12 -0.215        1.09  -0.503   0.714  1.66     -0.162   -0.419 -0.528 
13  0.760        1.16   0.386   1.67   0.0138    2.10    -0.419  2.09  </code></pre>
</div>
</div>
</section>
<section id="evaluate-linear-model" class="level3">
<h3 class="anchored" data-anchor-id="evaluate-linear-model">Evaluate linear model</h3>
<p>Once we have our <code>lm.predict</code> dataset that contains the predicted and test values, we can now use the <code>metrics</code> fiction to evaluate the accuracy of the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a>lm.predict<span class="sc">%&gt;%</span></span>
<span id="cb29-2"><a href="#cb29-2"></a>  <span class="fu">metrics</span>(<span class="at">truth =</span> chl, <span class="at">estimate =</span> .pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 x 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rmse    standard       0.740
2 rsq     standard       0.194
3 mae     standard       0.629</code></pre>
</div>
</div>
</section>
<section id="estimate-stats" class="level3">
<h3 class="anchored" data-anchor-id="estimate-stats">Estimate stats</h3>
<p>Sometimes you may wish to plot predicted values with different predictors. To do that you need to create a new tidied data from the the model with <code>tidy</code> function and parse <code>interval = TRUE</code> argument as shown in the code below. This create a tibble shown below and the same data is plotted in figure @ref(fig:fig3).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>lm.fit.stats <span class="ot">=</span> lm.fit <span class="sc">%&gt;%</span> </span>
<span id="cb31-2"><a href="#cb31-2"></a>  <span class="fu">tidy</span>(<span class="at">interval =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-3"><a href="#cb31-3"></a></span>
<span id="cb31-4"><a href="#cb31-4"></a>lm.fit.stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 x 5
  term         estimate std.error statistic p.value
  &lt;chr&gt;           &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
1 (Intercept) -3.41e-17     0.200 -1.71e-16   1    
2 temperature  1.29e- 2     0.253  5.09e- 2   0.960
3 do          -2.09e- 2     0.261 -8.00e- 2   0.937
4 ph           6.88e- 2     0.289  2.38e- 1   0.814
5 ammonia     -1.63e- 1     0.235 -6.96e- 1   0.494
6 phosphate    2.91e- 1     0.277  1.05e+ 0   0.306
7 nitrate     -6.99e- 2     0.316 -2.21e- 1   0.827</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a>lm.fit.stats <span class="sc">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2"></a>  <span class="fu">slice</span>(<span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-3"><a href="#cb33-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> term, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb33-4"><a href="#cb33-4"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">4</span>)<span class="sc">+</span></span>
<span id="cb33-5"><a href="#cb33-5"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> estimate<span class="sc">-</span>std.error, <span class="at">ymax =</span> estimate<span class="sc">+</span>std.error), <span class="at">width =</span> .<span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb33-6"><a href="#cb33-6"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">1.5</span>,<span class="fl">1.5</span>,<span class="fl">0.5</span>))<span class="sc">+</span></span>
<span id="cb33-7"><a href="#cb33-7"></a>  ggpubr<span class="sc">::</span><span class="fu">theme_pubclean</span>()<span class="sc">+</span></span>
<span id="cb33-8"><a href="#cb33-8"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>))<span class="sc">+</span></span>
<span id="cb33-9"><a href="#cb33-9"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Estimated chl"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-fig3" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-fig3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="index_files/figure-html/fig-fig3-1.png" class="img-fluid figure-img" width="672">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-fig3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Estimated value of chlorophyll concentration at different predictors
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="bayesian-approach" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-approach">Bayesian approach</h2>
<section id="make-bayes-model" class="level3">
<h3 class="anchored" data-anchor-id="make-bayes-model">Make Bayes Model</h3>
<p>For Bayesian, we also change the engine and specified are called <code>prior</code> and <code>prior_intercept</code>. It turns out that <code>linear_reg()</code> has a <code>stan</code> engine. Since these prior distribution arguments are specific to the Stan software, they are passed as arguments to <code>parsnip::set_engine()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a>prior.dist <span class="ot">=</span> rstanarm<span class="sc">::</span><span class="fu">student_t</span>(<span class="at">df =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="fu">set.seed</span>(<span class="dv">401</span>)</span>
<span id="cb35-2"><a href="#cb35-2"></a></span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="do">## make the parsnip model</span></span>
<span id="cb35-4"><a href="#cb35-4"></a>bayes.model <span class="ot">=</span> <span class="fu">linear_reg</span>() <span class="sc">%&gt;%</span></span>
<span id="cb35-5"><a href="#cb35-5"></a>  <span class="fu">set_engine</span>(<span class="at">engine =</span> <span class="st">"stan"</span>, </span>
<span id="cb35-6"><a href="#cb35-6"></a>             <span class="at">prior_intercept =</span> prior.dist, </span>
<span id="cb35-7"><a href="#cb35-7"></a>             <span class="at">prior =</span> prior.dist) <span class="sc">%&gt;%</span></span>
<span id="cb35-8"><a href="#cb35-8"></a>  <span class="fu">set_mode</span>(<span class="at">mode =</span> <span class="st">"regression"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This kind of Bayesian analysis (like many models) involves randomly generated numbers in its fitting procedure. We can use <code>set.seed()</code> to ensure that the same (pseudo-)random numbers are generated each time we run this code. The number 123 isn’t special or related to our data; it is just a “seed” used to choose random numbers.</p>
</section>
<section id="train-bayes-model" class="level3">
<h3 class="anchored" data-anchor-id="train-bayes-model">Train Bayes model</h3>
<p>Once we have defined the Bayesian model, we train it using a transformed testing set;</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a><span class="do">## train the bayes model</span></span>
<span id="cb36-2"><a href="#cb36-2"></a>bayes.fit <span class="ot">=</span> bayes.model<span class="sc">%&gt;%</span></span>
<span id="cb36-3"><a href="#cb36-3"></a>  <span class="fu">fit</span>(chl <span class="sc">~</span> ., <span class="at">data =</span> crtr.testing)</span>
<span id="cb36-4"><a href="#cb36-4"></a></span>
<span id="cb36-5"><a href="#cb36-5"></a>bayes.fit</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>parsnip model object

stan_glm
 family:       gaussian [identity]
 formula:      chl ~ .
 observations: 13
 predictors:   7
------
            Median MAD_SD
(Intercept) -0.2    0.2  
temperature -0.5    0.3  
do           0.4    0.4  
ph           0.6    0.4  
ammonia      0.1    0.2  
phosphate    0.6    0.3  
nitrate     -0.5    0.3  

Auxiliary parameter(s):
      Median MAD_SD
sigma 0.7    0.2   

------
* For help interpreting the printed output see ?print.stanreg
* For info on the priors used see ?prior_summary.stanreg</code></pre>
</div>
</div>
</section>
<section id="predict-bayes-fit" class="level3">
<h3 class="anchored" data-anchor-id="predict-bayes-fit">Predict Bayes fit</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>bayes.predict <span class="ot">=</span> bayes.fit <span class="sc">%&gt;%</span></span>
<span id="cb38-2"><a href="#cb38-2"></a>  <span class="fu">predict</span>(crtr.testing) <span class="sc">%&gt;%</span></span>
<span id="cb38-3"><a href="#cb38-3"></a>  <span class="fu">bind_cols</span>(crtr.testing)</span>
<span id="cb38-4"><a href="#cb38-4"></a></span>
<span id="cb38-5"><a href="#cb38-5"></a>bayes.predict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 x 8
     .pred temperature      do     ph ammonia phosphate nitrate     chl
     &lt;dbl&gt;       &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
 1 -0.607        0.407  0.624  -0.756  1.05     -0.485   -0.364 -0.685 
 2 -0.302       -0.897  0.603  -1.56   0.401    -0.242   -0.419 -0.0561
 3 -0.827       -0.897  0.516  -1.20   0.530     0.0808   1.32   0.206 
 4 -0.617       -1.10   1.69   -1.64   0.562     1.86     3.49  -0.894 
 5  0.0850      -0.966  1.30   -0.976 -0.0507   -0.565   -0.364 -0.161 
 6 -0.611       -1.58  -0.0480 -1.12   0.498     0.0808   1.26  -1.31  
 7  0.379       -1.58   1.17   -0.462  2.05     -0.525    0.721  0.573 
 8  0.0950       0.887  0.538   0.493 -0.244     0.121   -0.473 -0.528 
 9 -0.686        0.887  0.429   0.420 -0.890    -0.202    0.341 -0.528 
10 -0.705        0.132 -0.850   0.567 -1.54     -0.767   -0.419 -0.632 
11 -0.516        0.613 -0.200   0.567  0.272    -0.767   -0.364 -0.423 
12 -0.256        1.09  -0.503   0.714  1.66     -0.162   -0.419 -0.528 
13  1.74         1.16   0.386   1.67   0.0138    2.10    -0.419  2.09  </code></pre>
</div>
</div>
</section>
<section id="evaluate-bayes-model" class="level3">
<h3 class="anchored" data-anchor-id="evaluate-bayes-model">Evaluate Bayes model</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a>bayes.predict <span class="sc">%&gt;%</span></span>
<span id="cb40-2"><a href="#cb40-2"></a>  <span class="fu">metrics</span>(<span class="at">truth =</span> chl, <span class="at">estimate =</span> .pred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 x 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 rmse    standard       0.432
2 rsq     standard       0.717
3 mae     standard       0.334</code></pre>
</div>
</div>
</section>
<section id="bayes.fit.stats" class="level3">
<h3 class="anchored" data-anchor-id="bayes.fit.stats">Bayes.fit.stats</h3>
<p>To update the parameter table, the <code>tidy()</code> method is once again used:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>bayes.stats <span class="ot">=</span> bayes.fit <span class="sc">%&gt;%</span> </span>
<span id="cb42-2"><a href="#cb42-2"></a>  broom.mixed<span class="sc">::</span><span class="fu">tidy</span>(<span class="at">intervals =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-3"><a href="#cb42-3"></a></span>
<span id="cb42-4"><a href="#cb42-4"></a>bayes.stats</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 x 3
  term        estimate std.error
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;
1 (Intercept)   -0.220     0.230
2 temperature   -0.541     0.338
3 do             0.394     0.370
4 ph             0.597     0.379
5 ammonia        0.120     0.222
6 phosphate      0.586     0.310
7 nitrate       -0.527     0.270</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>bayes.stats <span class="sc">%&gt;%</span> </span>
<span id="cb44-2"><a href="#cb44-2"></a>  <span class="fu">slice</span>(<span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> term, <span class="at">y =</span> estimate)) <span class="sc">+</span></span>
<span id="cb44-4"><a href="#cb44-4"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">4</span>)<span class="sc">+</span></span>
<span id="cb44-5"><a href="#cb44-5"></a>  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> estimate <span class="sc">-</span> std.error, <span class="at">ymax =</span> estimate <span class="sc">+</span> std.error), <span class="at">width =</span> .<span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb44-6"><a href="#cb44-6"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">1.5</span>,<span class="fl">1.5</span>,<span class="fl">0.5</span>))<span class="sc">+</span></span>
<span id="cb44-7"><a href="#cb44-7"></a>  ggpubr<span class="sc">::</span><span class="fu">theme_pubclean</span>()<span class="sc">+</span></span>
<span id="cb44-8"><a href="#cb44-8"></a>  <span class="fu">theme</span>(<span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>))<span class="sc">+</span></span>
<span id="cb44-9"><a href="#cb44-9"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">""</span>, <span class="at">y =</span> <span class="st">"Estimated chl"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-30-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="links" class="level2">
<h2 class="anchored" data-anchor-id="links">Links</h2>
<ul>
<li><a href="http://www.wvview.org/os_sa/20_tidymodels.html">Machine Learning with tidymodels</a></li>
</ul>
</section>
<section id="cited-materials" class="level2">




</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">Cited Materials</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-rsample" class="csl-entry" role="listitem">
Kuhn, M., Chow, F., Wickham, H., 2020. <a href="https://CRAN.R-project.org/package=rsample">Rsample: General resampling infrastructure</a>.
</div>
<div id="ref-parsnip" class="csl-entry" role="listitem">
Kuhn, M., Vaughan, D., 2020a. <a href="https://CRAN.R-project.org/package=parsnip">Parsnip: A common API to modeling and analysis functions</a>.
</div>
<div id="ref-yardstick" class="csl-entry" role="listitem">
Kuhn, M., Vaughan, D., 2020b. <a href="https://CRAN.R-project.org/package=yardstick">Yardstick: Tidy characterizations of model performance</a>.
</div>
<div id="ref-tidymodels" class="csl-entry" role="listitem">
Kuhn, M., Wickham, H., 2020a. <a href="https://CRAN.R-project.org/package=tidymodels">Tidymodels: Easily install and load the ’tidymodels’ packages</a>.
</div>
<div id="ref-recipes" class="csl-entry" role="listitem">
Kuhn, M., Wickham, H., 2020b. <a href="https://CRAN.R-project.org/package=recipes">Recipes: Preprocessing tools to create design matrices</a>.
</div>
<div id="ref-r" class="csl-entry" role="listitem">
R Core Team, 2018. <a href="https://www.R-project.org/">R: A language and environment for statistical computing</a>. R Foundation for Statistical Computing, Vienna, Austria.
</div>
<div id="ref-ggally" class="csl-entry" role="listitem">
Schloerke, B., Crowley, J., Cook, D., Briatte, F., Marbach, M., Thoen, E., Elberg, A., Larmarange, J., 2020. <a href="https://CRAN.R-project.org/package=GGally">GGally: Extension to ’ggplot2’</a>.
</div>
<div id="ref-readxl" class="csl-entry" role="listitem">
Wickham, H., Bryan, J., 2018. <a href="https://CRAN.R-project.org/package=readxl">Readxl: Read excel files</a>.
</div>
<div id="ref-dplyr" class="csl-entry" role="listitem">
Wickham, H., François, R., Henry, L., Müller, K., 2019. <a href="https://CRAN.R-project.org/package=dplyr">Dplyr: A grammar of data manipulation</a>.
</div>
<div id="ref-tidyverse" class="csl-entry" role="listitem">
Wickham, H., Wickham, M.H., 2017. <a href="https://CRAN.R-project.org/package=tidyverse">Tidyverse: Easily install and load the ’tidyverse’</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>